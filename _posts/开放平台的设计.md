## 开放的平台
* 平台系统包含 应用、业务、接入、媒体、驱动
* 接入层有自己的标准协议，驱动有专门的SDK
* 应用、业务、媒体都需要对外提供接口
* 应用二次开发
    - 场景
        - 呈现不同的UI
        - PC/WEB/MOBILE等应用
    - 特点
        - 侧重于数据的获取，用户的多样性

* 业务二次开发
    - 场景
        - 定制不同的业务场景
        - 比如远程授课、医疗协助、审讯归档
    - 特点
        - 侧重于操作的重组，需要支持一些串行和异步操作
* 媒体二次开发
    - 场景
        - 使用媒体设备进行自有系统搭建
    - 特点
        - 侧重于模块的单一、数据的实施性


## 需求梳理
* 原始系统
        当前系统并不是一个新建的系统，它是一个完整的已有系统，需要将它开放出来。
        已有系统有很多模块，用不同的语言实现（JAVA C++ Python）
        模块之间通信方式有多种（MQ TCP HTTP）
        原有系统上层应用没有太多考虑过用户量问题（未上千）
* 研发需求
        为平台指定统一的对外接口（Http+Json）
        为媒体提供一套开放接口（C++ lib库）
        尽量减少对原有系统的改动 

## 设计
        有两种方式去定义API接入层的功能，主要是侧重工作量的问题，一种是API接入仅仅做转发，
    另外一种是API接入需要负责请求转发、数据转换、接口整合等

* 接入层-API转发服务器
    - 要求各系统按照规范要求，提供新的接口
    - API接入负责将请求分发到不同的服务器上（调用者只关心一个IP地址）
    - API负责拦截一些非正常请求，比如不携带token、请求频率过快
    - 侵入式改造当前系统，API组合不够灵活，但便于实现
* 接入层-API调度服务器
    - 子系统不做过多改造
    - API接入负责实现新API接口
    - 新接口需要组合调度各子系统现有的接口，可能包含MQ/HTTP/私有TCP协议等
    - 组合调度完成后需要统一转换回复到统一的接口内容
    - 非侵入式的改造原有系统，功能组合灵活，但编码复杂度和工作量会提高
    - 有些时候，由于老系统并没有实现什么流水号之类的，可能根本完成不了组合操作
    
### 协议选择
        现在的开放平台，基本很少见到不使用REST方式的，REST基本已经成为一种默认标准，
    仅仅在REST实际接口定义上，可能存在各个厂家的不同
        REST需要换一种思考方式去定义接口，其实有点像OO的观点，一切皆对象
        比如我们需要开启一个会议，原有理解可能会制定接口为 http://{ip}/api/v1/startconf
        但以一切皆对象的观点，那其实是去创建一个会议对象 http://{ip}/api/v1/confs 
        所有的动作都采用http原生方法 GET POST PUT DELETE（查、增、改、删）
* Http+Json协议
* C++静态库
* Restful的命名原则

### 认证相关
        目前比较流行的认证模型就是OAuth2.0，它在不泄漏用户账户的情况下，给予应用更多的授权

### 老系统的改造
        对于一个老系统，一般会有两种情况，一种是Java为主，数据存储为Mysql，无二级缓存，API会让访问量陡增，原有系统无法处理
        二种是以C++为主，根本就没有缓存，数据都在内存里面，这种系统虽然处理请求会很快速，但是大量的GET类请求会让原有系统无暇处理其它请求

* 现状
    - 一个C++写的核心系统
    - 业务复杂，属于一个中心控制系统，和多个系统打交道
    - 对外通信为MQ
* 调整
    - 重新用Python设计一个模块，为其提供API服务（为什么不沿用C++，因为C++做Http服务很蠢）
    - 正常请求类通信走原有MQ
        + C++原有通信逻辑为REQ-ACK-NOTIFY策略，ACK不带业务处理ID，新增ID
        + 每一个REQ创建对象必定回复一个对象ID，无论对象是在何时创建成功
    - 核心模块 数据与逻辑的剥离，将数据写到缓存，用于API查询
        + 这里主要是通过订阅MQ消息，将数据写到Redis上，减少对核心系统的侵入
        + API的查询统一读取Redis数据，避免向核心系统转发大量请求

### 新系统的设计
* API网关
    - 统一接入API请求
    - API请求重定向
    - API权限控制（非业务权限，仅仅为API权限）
    - API安全控制

### 媒体接口
* 回调里面带上下文，方便业务逻辑
* 接口设计尽量用C++原生内置数据类型，不用STL
* 接口带namespace防止类重名
* 如果是DLL，尽量不要使用虚函数，避免二进制兼容
* 如果只提供库+头文件，需要针对不同的平台、不同编译器版本给不同的库。
* 可以使用pimpl模型屏蔽成员变量细节

## 实施细则
* 命名的统一（对于已有系统来说，这一点并不是那么好做，需要评审的时候注意，因为一旦发布后，已有API基本上是很难调整）
    - 统一的格式
        + 单词所有小写，单词之间用_表示
        + Json中字段的值定义统一
            * 使用0 1表示false true
            * 使用空字段表示非必填参数，不使用null
            * 数字不用字符串
    - 统一的表达
        + 多个系统之间可能表达同一个意思的单词不一致，需要统一
* 字段的统一
* 文档的管理
        我们的产品既有公有云，也有私有云，API文档分为线上和线下，为了节省劳动力，
    统一以Html形式提供，既能线上也能线下
        API文档的生成我们使用Python做了一个小工具，开发人员只需要按照格式写，就
    能自动生成html文档
        文档里面有些关键的特性一定要明确，版本号、版本修改记录、参数说明（必填、非必填）、
        字段空缺以什么形式，null还是空缺

## 问题处理
* 兼容问题
    - 如果是API有Bug，那直接升级平台
    - 如果是API字段有错误，平台发布更新文档，但平台要做兼容
    - 如果是API字段有不一致，建议整理需求，当到达一定量的时候，规划V2版本，对于没有修改的接口，直接通过接入服务器跳转
* 
